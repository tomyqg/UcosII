#include "stm32f10x.h"
#include "stm32f10x_dac.h"
#include "stm32f10x_dma.h"
#include "includeFile.h"
#include "dmadac.h"

#define DAC_DHR12RD_Address      0x40007420 
uint32_t DualSine12bit[640];


#ifdef Create_Sinusoidal 
/* 正弦波波形数据 ---------------------------------------------------------*/
const uint16_t Sine12bit[640] = {
  
  2047,2061,2074,2088,2102,2115,2129,2142,2156,2170,2183,2197,2210,2224,2237,2251,2264,
  2278,2291,2305,2318,2332,2345,2358,2371,2385,2398,2411,2424,2437,2450,2464,2477,2489,
  2502,2515,2528,2541,2554,2566,2579,2592,2604,2617,2629,2641,2654,2666,2678,2690,2702,
  2714,2726,2738,2750,2762,2773,2785,2796,2808,2819,2831,2842,2853,2864,2875,2886,2897,
  2908,2918,2929,2939,2950,2960,2970,2980,2991,3001,3010,3020,3030,3039,3049,3058,3068,
  3077,3086,3095,3104,3113,3121,3130,3139,3147,3155,3163,3172,3180,3187,3195,3203,3210,
  3218,3225,3232,3239,3246,3253,3260,3266,3273,3279,3285,3292,3298,3304,3309,3315,3321,
  3326,3331,3336,3341,3346,3351,3356,3360,3365,3369,3373,3377,3381,3385,3388,3392,3395,
  3399,3402,3405,3408,3410,3413,3415,3418,3420,3422,3424,3426,3427,3429,3430,3432,3433,
  3434,3435,3435,3436,3436,3437,3437,3437,3437,3437,3436,3436,3435,3435,3434,3433,3432,
  3430,3429,3427,3426,3424,3422,3420,3418,3415,3413,3410,3408,3405,3402,3399,3395,3392,
  3388,3385,3381,3377,3373,3369,3365,3360,3356,3351,3346,3341,3336,3331,3326,3321,3315,
  3309,3304,3298,3292,3285,3279,3273,3266,3260,3253,3246,3239,3232,3225,3218,3210,3203,
  3195,3187,3180,3172,3163,3155,3147,3139,3130,3121,3113,3104,3095,3086,3077,3068,3058,
  3049,3039,3030,3020,3010,3001,2991,2980,2970,2960,2950,2939,2929,2918,2908,2897,2886,
  2875,2864,2853,2842,2831,2819,2808,2796,2785,2773,2762,2750,2738,2726,2714,2702,2690,
  2678,2666,2654,2641,2629,2617,2604,2592,2579,2566,2554,2541,2528,2515,2502,2489,2477,
  2464,2450,2437,2424,2411,2398,2385,2371,2358,2345,2332,2318,2305,2291,2278,2264,2251,
  2237,2224,2210,2197,2183,2170,2156,2142,2129,2115,2102,2088,2074,2061,2047,2033,2020,
  2006,1992,1979,1965,1952,1938,1924,1911,1897,1884,1870,1857,1843,1830,1816,1803,1789,
  1776,1762,1749,1736,1723,1709,1696,1683,1670,1657,1644,1630,1617,1605,1592,1579,1566,
  1553,1540,1528,1515,1502,1490,1477,1465,1453,1440,1428,1416,1404,1392,1380,1368,1356,
  1344,1332,1321,1309,1298,1286,1275,1263,1252,1241,1230,1219,1208,1197,1186,1176,1165,
  1155,1144,1134,1124,1114,1103,1093,1084,1074,1064,1055,1045,1036,1026,1017,1008,999,
  990,981,973,964,955,947,939,931,922,914,907,899,891,884,876,869,862,855,848,841,834,
  828,821,815,809,802,796,790,785,779,773,768,763,758,753,748,743,738,734,729,725,721,
  717,713,709,706,702,699,695,692,689,686,684,681,679,676,674,672,670,668,667,665,664,
  662,661,660,659,659,658,658,657,657,657,657,657,658,658,659,659,660,661,662,664,665,
  667,668,670,672,674,676,679,681,684,686,689,692,695,699,702,706,709,713,717,721,725,
  729,734,738,743,748,753,758,763,768,773,779,785,790,796,802,809,815,821,828,834,841,
  848,855,862,869,876,884,891,899,907,914,922,931,939,947,955,964,973,981,990,999,1008,
  1017,1026,1036,1045,1055,1064,1074,1084,1093,1103,1114,1124,1134,1144,1155,1165,1176,
  1186,1197,1208,1219,1230,1241,1252,1263,1275,1286,1298,1309,1321,1332,1344,1356,1368,
  1380,1392,1404,1416,1428,1440,1453,1465,1477,1490,1502,1515,1528,1540,1553,1566,1579,
  1592,1605,1617,1630,1644,1657,1670,1683,1696,1709,1723,1736,1749,1762,1776,1789,1803,
  1816,1830,1843,1857,1870,1884,1897,1911,1924,1938,1952,1965,1979,1992,2006,2020,2033
  

 }; 

#else
/*噪声波形*/
const uint16_t Noise12bit[640] = {
  2212,1825,2157,2256,2478,1833,2043,2447,3028,1975,2846,1827,2503,3075,2180,2392,2834,2725,
  2407,2884,2793,3112,2184,2569,2432,2439,2631,2210,2468,2618,2326,3024,3030,3010,2942,2679,
  3555,3099,3112,2731,2859,2852,2919,2942,3388,3449,3621,3572,2724,3264,3006,2516,2985,3511,
  3330,2366,2975,3567,3285,2973,3057,3283,3835,2475,2652,3290,2369,3343,3261,4038,2808,2703,
  2662,2798,2695,2928,2442,3034,3085,2844,2409,2838,3677,2550,2632,2023,3370,3042,3055,2740,
  3207,2746,3359,2462,2002,2772,2765,2868,3123,2825,2940,2969,3686,3406,2176,2521,2879,3127,
  3195,3020,2833,3102,3338,2739,2847,3309,3064,2802,3037,2239,2725,2707,3289,3329,3422,3919,
  2444,3484,2618,2831,3641,2880,3322,2609,2970,3644,2783,2476,2556,3194,2604,3370,2360,3401,
  2790,2989,3042,2581,3187,3564,3431,3519,3940,3412,3053,3473,3304,2863,3533,3293,3717,4032,
  3351,3575,3567,3005,3520,3309,3637,3395,2903,3329,3146,3758,3906,2803,4360,3644,3986,3330,
  4145,3476,3880,4472,3301,3771,3219,3330,3873,3746,3918,3318,3339,3595,4293,4063,3678,4245,
  4127,3685,3669,3290,4047,4152,3905,4158,4289,4372,3757,3521,3087,3671,3201,3127,4236,3787,
  3055,3250,4118,3992,3591,3428,2804,3413,3813,3802,3972,3634,3665,2862,3363,3448,3625,3282,
  2899,3256,3254,3508,2728,3505,2953,2486,2766,3467,2805,2561,2927,2361,3287,3247,2280,3444,
  2905,2630,2474,2067,2775,2106,2223,2033,2468,2520,2164,2799,2685,2296,2701,3162,2052,2239,
  1838,2913,2063,2450,2753,2394,2990,1904,1568,2188,1835,2386,1429,2353,2126,2182,2119,2449,
  2464,2263,1405,2766,2431,2027,1964,2299,2067,2834,2123,2281,2063,1834,1386,1552,1665,1501,
  2107,1788,2107,1664,1596,1602,2307,2718,2519,2463,1241,1658,2513,1404,1592,1243,2697,1585,
  1301,2672,1471,2040,1332,1959,2181,1671,2216,2634,1981,2077,2005,1689,2367,1806,1820,2757,
  2512,2656,2484,1821,1689,2126,2101,1695,2429,1485,2068,1850,2207,1904,1597,2208,1512,2562,
  2354,1755,1888,2072,1729,1429,1742,2387,2086,2372,1239,1757,1215,464 ,2183,1792,1301,1845,
  1315,1446,1705,2378,630,1092,1317,1404,1943,1298,2125,1578,1171,813,914,1507,1372,826,900,
  713,1419,1438,872,1967,1467,921,785,1329,1050,551,512,1008,980,468,486,348,723,488,369,1138,
  338,631,643,425,474,579,1388,931,890,756,575,439,363,896,144,276,464,104,703,368,55,829,7,
  978,486,394,162,112,521,27,636,839,340,378,251,119,793,917,74,223,289,471,257,960,3,821,883,
  168,450,283,1161,927,482,777,350,850,759,147,547,819,655,387,936,442,550,267,1263,396,338,
  1006,902,575,131,1290,836,1030,1007,669,56,1204,1157,801,1234,1576,1364,1523,787,1246,1371,
  939,793,1321,659,1413,1559,1022,1000,853,1452,1127,1008,1377,1360,1507,944,1291,1022,1291,
  559,1188,1343,1933,479,912,1121,895,1293,1453,766,987,1446,1536,1321,647,1098,1428,1363,342,
  1071,1004,1551,904,116,1596,716,1387,854,1253,956,1409,1544,1646,1371,1001,998,687,1690,828,
  33,1091,671,1567,505,774,1206,762,1539,1169,391,750,726,1083,633,889,1301,471,1179,1264,877,
  1128,945,1317,650,1283,861,2417,978,1051,640,367,1135,363,839,1882,1298,1081,1429,872,1114,
  1042,981,1330,505,668,853,2232,613,1270,1471,1396,1756,1451,1217,1173,1436,2008,1944,1743,
  1350,2005,1691,2133,1924,2310,1603,2326,2179,2123,2483,2335,2146,2053
};
#endif

/************************************************************************************************
Function Name    :DAC_Config
Function Input   :void
Function Output  :void
Function Describe:adc init
************************************************************************************************/
static void DAC_Config(void)
{
    GPIO_InitTypeDef GPIO_InitStructure;
    DAC_InitTypeDef  DAC_InitStructure;

    /* 使能GPIOA时钟 */
    RCC_APB2PeriphClockCmd(RCC_APB2Periph_GPIOA, ENABLE);	

    /* 使能DAC时钟 */	
    RCC_APB1PeriphClockCmd(RCC_APB1Periph_DAC, ENABLE);

    /* DAC的GPIO配置，模拟输入 */
    GPIO_InitStructure.GPIO_Pin =  GPIO_Pin_4 | GPIO_Pin_5;
    GPIO_InitStructure.GPIO_Mode = GPIO_Mode_AIN;
    GPIO_Init(GPIOA, &GPIO_InitStructure);



    /* 配置DAC 通道1 */
    DAC_InitStructure.DAC_Trigger = DAC_Trigger_T2_TRGO;		//使用TIM2作为触发源
    DAC_InitStructure.DAC_WaveGeneration = DAC_WaveGeneration_None;	//不使用波形发生器
    DAC_InitStructure.DAC_OutputBuffer = DAC_OutputBuffer_Disable;	//不使用DAC输出缓冲
    DAC_Init(DAC_Channel_1, &DAC_InitStructure);

    /* 配置DAC 通道2 */
    DAC_Init(DAC_Channel_2, &DAC_InitStructure);

    /* 使能通道1 由PA4输出 */
    DAC_Cmd(DAC_Channel_1, ENABLE);
    /* 使能通道2 由PA5输出 */
    DAC_Cmd(DAC_Channel_2, ENABLE);

    /* 使能DAC的DMA请求 */
    DAC_DMACmd(DAC_Channel_2, ENABLE);
}


/************************************************************************************************
Function Name    :DAC_TIM_Config
Function Input   :void
Function Output  :void
Function Describe:tigger DMA tim init
************************************************************************************************/
static void DAC_TIM_Config(void)
{
	
    TIM_TimeBaseInitTypeDef    TIM_TimeBaseStructure;

    /* 使能TIM2时钟，TIM2CLK 为72M */
    RCC_APB1PeriphClockCmd(RCC_APB1Periph_TIM2, ENABLE);

    /* TIM2基本定时器配置 */
    // TIM_TimeBaseStructInit(&TIM_TimeBaseStructure); 
    TIM_TimeBaseStructure.TIM_Period = 224;      //定时周期 20  
    TIM_TimeBaseStructure.TIM_Prescaler = 9;      //预分频，不分频 72M / (0+1) = 72M
    TIM_TimeBaseStructure.TIM_ClockDivision = 0x0;   //时钟分频系数
    TIM_TimeBaseStructure.TIM_CounterMode = TIM_CounterMode_Up; //向上计数模式
    TIM_TimeBaseInit(TIM2, &TIM_TimeBaseStructure);

    /* 配置TIM2触发源 */
    TIM_SelectOutputTrigger(TIM2, TIM_TRGOSource_Update);

    /* 使能TIM2 */
    TIM_Cmd(TIM2, ENABLE);
    
}





/************************************************************************************************
Function Name    :DAC_DMA_Config
Function Input   :void
Function Output  :void
Function Describe:DMA DAC init
************************************************************************************************/
static void DAC_DMA_Config(void)
{	
    DMA_InitTypeDef  DMA_InitStructure;

    /* 使能DMA2时钟 */
    RCC_AHBPeriphClockCmd(RCC_AHBPeriph_DMA2, ENABLE);

    /* 配置DMA2 */
    DMA_InitStructure.DMA_PeripheralBaseAddr = DAC_DHR12RD_Address;	//外设数据地址
    DMA_InitStructure.DMA_MemoryBaseAddr = (uint32_t)&DualSine12bit ;   //内存数据地址 DualSine12bit
    DMA_InitStructure.DMA_DIR = DMA_DIR_PeripheralDST;			//数据传输方向内存至外设
    DMA_InitStructure.DMA_BufferSize = 640;				//缓存大小为32字节	
    DMA_InitStructure.DMA_PeripheralInc = DMA_PeripheralInc_Disable;	//外设数据地址固定	
    DMA_InitStructure.DMA_MemoryInc = DMA_MemoryInc_Enable;		//内存数据地址自增
    DMA_InitStructure.DMA_PeripheralDataSize = DMA_PeripheralDataSize_Word;//外设数据以字为单位
    DMA_InitStructure.DMA_MemoryDataSize = DMA_MemoryDataSize_Word;	//内存数据以字为单位	
    DMA_InitStructure.DMA_Mode = DMA_Mode_Circular;			//循环模式
    DMA_InitStructure.DMA_Priority = DMA_Priority_High;			//高DMA通道优先级
    DMA_InitStructure.DMA_M2M = DMA_M2M_Disable;			//非内存至内存模式	

    DMA_Init(DMA2_Channel4, &DMA_InitStructure);

    /* 使能DMA2-14通道 */
    DMA_Cmd(DMA2_Channel4, ENABLE);
}







/************************************************************************************************
Function Name    :DAC_Mode_Init
Function Input   :void
Function Output  :void
Function Describe:create waveform init
************************************************************************************************/
void DAC_Mode_Init(void)
{
    uint32_t Idx = 0;  

    DAC_Config();
    DAC_TIM_Config();
    DAC_DMA_Config();

    /* 填充正弦波形数据，双通道右对齐*/
    for (Idx = 0; Idx < 640; Idx++)
    {
      #ifdef Create_Sinusoidal 
        DualSine12bit[Idx] = (Sine12bit[Idx] << 16) + (Sine12bit[Idx]);
      #else
        DualSine12bit[Idx] = (Noise12bit[Idx] << 16) + (Noise12bit[Idx]);
      #endif
    }
}

